# 运行时日志系统使用说明

## 概述

游戏内置了运行时日志记录系统，可以在代码中记录重要的运行时信息，这些信息会在按 Y 键保存调试日志时一起导出。

## 基本使用

### 在代码中记录日志

运行时日志系统提供了 4 种日志级别：

```gdscript
# 1. 调试信息 (DEBUG)
DebugLogger.log_debug("玩家位置: " + str(position), "PlayerController")

# 2. 一般信息 (INFO)
DebugLogger.log_info("关卡加载完成", "LevelManager")

# 3. 警告信息 (WARNING)
DebugLogger.log_warning("血量低于 20%", "HealthSystem")

# 4. 错误信息 (ERROR)
DebugLogger.log_error("无法加载配置文件", "ConfigManager")
```

### 参数说明

所有日志函数都接受两个参数：

1. **message** (必需): 日志消息内容
2. **context** (可选): 上下文信息，通常是类名或模块名

```gdscript
DebugLogger.log_info(message, context)
```

## 使用示例

### 示例 1: 战斗系统日志

```gdscript
# scripts/battle/battle_manager.gd
extends Node

func start_battle():
    DebugLogger.log_info("战斗开始", "BattleManager")
    
func on_enemy_damaged(damage: float, enemy_name: String):
    DebugLogger.log_debug("敌人受到伤害: %s (伤害值: %.1f)" % [enemy_name, damage], "BattleManager")
    
func on_player_died():
    DebugLogger.log_warning("玩家死亡", "BattleManager")
```

### 示例 2: 资源加载日志

```gdscript
# scripts/autoload/data_manager.gd
extends Node

func load_character_data(character_id: String):
    DebugLogger.log_info("开始加载角色数据: " + character_id, "DataManager")
    
    var data = _load_data(character_id)
    if data == null:
        DebugLogger.log_error("角色数据加载失败: " + character_id, "DataManager")
        return null
    
    DebugLogger.log_info("角色数据加载成功: " + character_id, "DataManager")
    return data
```

### 示例 3: 事件系统日志

```gdscript
# scripts/events/event_manager.gd
extends Node

func trigger_event(event_name: String):
    DebugLogger.log_info("触发事件: " + event_name, "EventManager")
    
    if not _validate_event(event_name):
        DebugLogger.log_warning("事件验证失败: " + event_name, "EventManager")
        return false
    
    _execute_event(event_name)
    return true
```

### 示例 4: 玩家操作日志

```gdscript
# scripts/characters/base_character.gd
extends CharacterBody2D

func use_skill(skill_id: int):
    DebugLogger.log_info("使用技能: " + str(skill_id), "Character")
    
    if skill_cooldown > 0:
        DebugLogger.log_warning("技能冷却中，无法使用", "Character")
        return
    
    # 执行技能...
    DebugLogger.log_debug("技能执行成功，伤害: " + str(damage), "Character")
```

## 高级功能

### 控制日志记录

```gdscript
# 禁用日志记录（提高性能）
DebugLogger.set_log_enabled(false)

# 启用日志记录
DebugLogger.set_log_enabled(true)
```

### 清空日志缓冲区

```gdscript
# 清空所有已记录的日志
DebugLogger.clear_log_buffer()
```

### 获取日志缓冲区

```gdscript
# 获取所有日志记录
var logs = DebugLogger.get_log_buffer()
for log in logs:
    print(log["timestamp"], log["level"], log["context"], log["message"], log["frame"])
```

### 日志条目字段说明

`get_log_buffer()` 返回 `Array[Dictionary]`，每条日志包含以下键：

- `timestamp`: 形如 `"14:30:15"`
- `level`: `"DEBUG"/"INFO"/"WARNING"/"ERROR"`
- `context`: 上下文（通常填模块/类名）
- `message`: 日志正文
- `frame`: 记录时的 `Engine.get_process_frames()`

## 日志缓冲区特性

- **容量限制**: 最多保存最近 1000 条日志
- **自动滚动**: 超过容量时，自动删除最旧的日志
- **性能优化**: 日志记录非常轻量，对游戏性能影响极小
- **持久化**: 按 Y 键时，所有缓冲的日志会保存到文件

## 日志文件格式

运行时日志在调试日志文件中的格式：

```
--------------------------------------------------------------------------------
运行时日志输出
--------------------------------------------------------------------------------
共 156 条日志记录 (最近 1000 条):

14:30:15 [INFO]   [BattleManager] (帧#1024): 战斗开始
14:30:16 [DEBUG]  [Character] (帧#1098): 使用技能: 1
14:30:18 [WARN]   [HealthSystem] (帧#1256): 血量低于 20%
14:30:20 [ERROR]  [DataManager] (帧#1420): 角色数据加载失败: invalid_id
```

## 最佳实践

### 1. 合理选择日志级别

- **DEBUG**: 详细的调试信息，如变量值、位置坐标
- **INFO**: 重要的状态变化，如关卡加载、战斗开始
- **WARNING**: 潜在问题，如资源不足、数值异常
- **ERROR**: 严重错误，如加载失败、空指针

### 2. 添加上下文信息

始终提供 context 参数，方便定位问题：

```gdscript
# 好的做法
DebugLogger.log_info("关卡加载完成", "LevelManager")

# 不推荐
DebugLogger.log_info("关卡加载完成")  # 难以定位是哪个模块
```

### 3. 记录关键事件

优先记录以下事件：
- 游戏状态转换
- 资源加载/卸载
- 玩家重要操作
- 错误和异常情况
- 性能相关信息

### 4. 避免过度记录

不要记录太频繁的事件（如每帧的位置更新），会填满缓冲区并影响性能。

```gdscript
# 不推荐 - 每帧都记录
func _process(delta):
    DebugLogger.log_debug("位置更新: " + str(position))  # ❌

# 推荐 - 只在重要时刻记录
func teleport(new_position):
    DebugLogger.log_info("传送到: " + str(new_position))  # ✓
```

### 5. 包含有用的上下文数据

```gdscript
# 好的做法 - 包含详细信息
DebugLogger.log_error(
    "技能施放失败: skill_id=%d, 原因=%s" % [skill_id, reason],
    "SkillSystem"
)

# 不推荐 - 信息不足
DebugLogger.log_error("技能施放失败", "SkillSystem")
```

## 与传统 print 的对比

| 特性 | DebugLogger | print() |
|------|-------------|---------|
| 记录到文件 | ✓ | ✗ |
| 日志级别 | ✓ | ✗ |
| 时间戳 | ✓ | ✗ |
| 上下文信息 | ✓ | ✗ |
| 可控制开关 | ✓ | ✗ |
| 自动缓冲 | ✓ | ✗ |

## 调试工作流

1. **开发阶段**: 在关键位置添加日志记录
2. **测试阶段**: 
   - 运行游戏
   - 重现问题
   - 按 Y 键保存日志
   - 分析日志文件
3. **发布阶段**: 保留日志系统，方便收集玩家反馈

## 性能考虑

- 日志记录非常轻量，每条日志约 100-200 字节
- 1000 条日志约占用 100-200KB 内存
- 如果担心性能，可以在发布版本中禁用 DEBUG 级别日志

```gdscript
# 在发布版本中只记录 INFO 及以上级别
func _ready():
    if not OS.is_debug_build():
        # 可以自行实现级别过滤
        pass
```

## 故障排查

### 日志没有记录？

检查：
1. 是否正确调用了 `DebugLogger.log_xxx()` 函数
2. 日志记录是否被禁用了（`DebugLogger.log_enabled`）
3. 是否超过了 1000 条限制（旧日志会被删除）

### 日志太多？

解决方法：
1. 减少日志记录频率
2. 只记录重要事件
3. 增加 `MAX_LOG_BUFFER_SIZE` 常量（修改 debug_logger.gd）

## 总结

运行时日志系统是一个强大的调试工具，可以：
- ✓ 记录游戏运行时的重要信息
- ✓ 帮助快速定位和修复问题
- ✓ 收集玩家的游戏状态信息
- ✓ 不影响游戏性能

建议在所有重要的游戏系统中添加适当的日志记录！
