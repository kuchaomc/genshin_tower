# 调试日志系统使用说明

## 功能说明

游戏内置了一个调试日志系统，可以帮助开发者收集玩家的游戏状态信息，用于问题诊断和调试。

## 如何使用

### 玩家操作

1. **在游戏中按下键盘 Y 键**
2. 屏幕左上角会显示通知，告知日志保存位置
3. 日志文件会自动保存

说明：该按键来自输入映射动作 `y`（见 `project.godot` 的 `[input]` 配置），如果你在项目设置里改了按键映射，以实际映射为准。

### 日志保存位置

#### 打包后的 exe 版本

日志系统会按以下优先级尝试保存：

1. **首选位置**：`游戏.exe` 所在目录下的 `logs` 文件夹
   - 例如：`C:\Games\YourGame\logs\debug_log_20260121_143052.txt`
   - 这是最方便玩家找到的位置

2. **备选位置**（如果 exe 目录无写入权限）：Windows 用户数据目录
   - 路径：`%APPDATA%\Godot\app_userdata\genshin\logs\`
   - 完整示例：`C:\Users\用户名\AppData\Roaming\Godot\app_userdata\genshin\logs\`
   - 游戏通知会显示完整的物理路径

#### 开发模式（Godot 编辑器）

- 默认位置：`user://logs/`
- Windows 实际物理路径通常为：`%APPDATA%\Godot\app_userdata\genshin\logs\`
- 可以在编辑器控制台与通知中看到完整物理路径（`ProjectSettings.globalize_path()` 结果）

### 日志文件命名

日志文件名格式：`debug_log_YYYYMMDD_HHMMSS.txt`

例如：`debug_log_20260121_143052.txt` 表示 2026年1月21日 14:30:52 生成的日志

## 日志包含的信息

每个日志文件包含以下详细信息：

### 1. 系统信息
- 操作系统版本
- Godot 引擎版本
- 可执行文件路径
- 是否为调试版本

### 2. 日志系统诊断
- 日志保存路径（虚拟路径和物理路径）
- 路径选择原因
- 初始化过程的详细记录

### 3. 性能信息
- 当前 FPS
- 渲染时间
- 物理处理时间
- 内存使用情况
- 场景节点数量

### 4. 当前场景信息
- 场景名称和路径
- 场景树结构（前3层节点）
- 节点位置和尺寸信息

### 5. 游戏管理器状态
- GameManager 状态
- RunManager 状态
- DataManager 状态
- 各管理器的自定义属性

### 6. 输入状态
- 鼠标位置
- 各个按键的当前状态

## 收集玩家日志的方法

### 给玩家的说明模板

```
如果您遇到问题，请帮助我们收集调试信息：

1. 在游戏中按下键盘 Y 键
2. 屏幕左上角会显示日志保存位置
3. 找到日志文件（通常在游戏 exe 所在目录的 logs 文件夹中）
4. 将日志文件发送给我们

日志文件可能的位置：
- 游戏.exe 所在目录\logs\ 文件夹
- 或者在游戏通知中显示的路径

日志文件名类似：debug_log_20260121_143052.txt
```

## 技术细节

### 路径选择逻辑

1. 编辑器模式：始终使用 `user://logs/`
2. 打包模式：
   - 尝试在 exe 目录创建 `logs` 文件夹
   - 测试写入权限（创建临时文件）
   - 如果成功，使用 exe 目录
   - 如果失败（权限问题），回退到 `user://logs/`

### 错误处理

- 如果主路径保存失败，自动尝试备选路径
- 所有错误信息都会输出到控制台
- 通知 UI 会显示实际的保存路径或错误信息

### 性能影响

- 日志系统仅在按下 Y 键时运行
- 不影响游戏正常运行的性能
- 日志收集过程可能需要 100-500ms（取决于场景复杂度）

## 常见问题

### Q: 为什么日志没有保存在 exe 目录？

A: 可能的原因：
- exe 所在目录没有写入权限（如在 Program Files 文件夹中）
- 杀毒软件阻止了文件写入
- 系统会自动使用备选路径（用户数据目录）

### Q: 如何快速找到备选路径的日志？

A: 
1. 按下 Windows + R
2. 输入：`%APPDATA%\Godot\app_userdata\genshin\logs\`
3. 按回车

### Q: 日志文件很大吗？

A: 通常每个日志文件在 10-50KB 左右，取决于场景复杂度

### Q: 可以禁用这个功能吗？

A: 可以，在 `project.godot` 中移除 `DebugLogger` 自动加载项即可

## 开发者注意事项

- 确保发布的游戏版本也包含此功能，方便收集玩家反馈
- 可以修改 `scripts/autoload/debug_logger.gd` 来自定义收集的信息
- 建议在游戏说明或 README 中告知玩家此功能
- 日志可能包含玩家的系统路径信息，注意隐私保护
